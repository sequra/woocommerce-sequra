#!/bin/bash
BASEDIR="$(dirname $(realpath $0))/.."
cd "${BASEDIR}"

# Install only production dependencies
bin/composer install --no-dev
bin/npm run build

cd "${BASEDIR}" || exit
set -o allexport
source .env
set +o allexport

 # Wait for ngrok tunnel to be ready. It should return a 200 status code when hitting $WP_URL
wait_for() {
	local retry=60
	local timeout=1
	local start=$(date +%s)

	while [ $(($(date +%s) - $start)) -lt $retry ]; do
		if "$@" > /dev/null 2>&1; then
			return 0
		fi
		sleep $timeout
	done
	return 1
}
echo "üöÄ Waiting for ngrok tunnel to be ready..."
result=$(wait_for curl -s -o /dev/null --header "ngrok-skip-browser-warning: 1" --head --fail "${WP_URL}")
if [ "$result" == "1" ]; then
	echo "‚ùå WordPress is not available at: ${WP_URL}"
	exit 1
fi
echo "‚úÖ WordPress is available at: ${WP_URL}"

# Check if --headed is passed
if [[ "$@" == *"--headed"* ]]; then
    cd sequra && npx playwright test $@
else
    docker run \
    --env-file "${BASEDIR}"/.env \
    -it --rm -v "${BASEDIR}"/sequra:/app -w /app mcr.microsoft.com/playwright:v1.45.0-jammy bash -c "npx playwright test $@"
fi
